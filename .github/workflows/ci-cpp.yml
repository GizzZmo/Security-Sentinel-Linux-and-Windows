name: üî® C++ Build CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.hpp'
      - 'CMakeLists.txt'
      - 'include/**'
      - 'src/**'
      - '.github/workflows/ci-cpp.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.hpp'
      - 'CMakeLists.txt'
      - 'include/**'
      - 'src/**'

jobs:
  build-windows:
    name: ü™ü Build Windows (MSVC)
    runs-on: windows-latest
    
    strategy:
      matrix:
        build_type: [Debug, Release]
        
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: üì¶ Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: üîß Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        
    - name: üî® Build C++ Project
      run: |
        cmake --build build --config ${{ matrix.build_type }} --parallel
        
    - name: üìã List build outputs
      run: |
        echo "### Build Output Files üìÅ" >> $env:GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $env:GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $env:GITHUB_STEP_SUMMARY
        Get-ChildItem -Path "build" -Recurse -Include "*.exe", "*.dll", "*.lib" | ForEach-Object {
          $size = [math]::Round($_.Length / 1KB, 2)
          echo "| $($_.FullName) | ${size} KB |" >> $env:GITHUB_STEP_SUMMARY
        }
        
    - name: üß™ Run basic executable test
      run: |
        echo "üîç Searching for built executable..."
        $exe_path = Get-ChildItem -Path "build" -Recurse -Include "SecuritySentinel.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($exe_path) {
          echo "‚úÖ Found executable: $($exe_path.FullName)"
          echo "üìè File size: $([math]::Round($exe_path.Length / 1MB, 2)) MB"
          echo "‚úÖ Executable built successfully" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "‚ö†Ô∏è SecuritySentinel.exe not found, checking for other executables..."
          $any_exe = Get-ChildItem -Path "build" -Recurse -Include "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($any_exe) {
            echo "‚úÖ Found executable: $($any_exe.FullName)" 
            echo "‚úÖ Build successful (alternate executable found)" >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "‚ùå No executable found in build directory" >> $env:GITHUB_STEP_SUMMARY
            exit 1
          }
        }
        
    - name: üì§ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cpp-build-${{ matrix.build_type }}
        path: |
          build/bin/
          build/Release/
          build/Debug/
        retention-days: 7

  code-analysis:
    name: üîç Static Code Analysis
    runs-on: windows-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üõ†Ô∏è Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: üì¶ Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: üîß Configure with static analysis
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Debug
        
    - name: üîç Run MSVC static analysis
      run: |
        echo "### Static Analysis Report üîç" >> $env:GITHUB_STEP_SUMMARY
        try {
          msbuild build/SecuritySentinel.vcxproj /p:Configuration=Debug /p:Platform=x64 /p:RunCodeAnalysis=true /p:CodeAnalysisRuleSet=AllRules.ruleset
          echo "‚úÖ Static analysis completed successfully" >> $env:GITHUB_STEP_SUMMARY
        } catch {
          echo "‚ö†Ô∏è Static analysis found issues (see build logs)" >> $env:GITHUB_STEP_SUMMARY
        }
      continue-on-error: true

  security-check:
    name: üîí Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      
    - name: üîç Run Semgrep security scan
      uses: semgrep/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/secrets
          p/cwe-top-25
        generateSarif: "1"
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      continue-on-error: true
      if: ${{ secrets.SEMGREP_APP_TOKEN != '' }}
        
    - name: üîç Skip Semgrep (no token)
      if: ${{ secrets.SEMGREP_APP_TOKEN == '' }}
      run: |
        echo "‚ö†Ô∏è SEMGREP_APP_TOKEN not configured, skipping security scan"
        echo "This is optional and workflow will continue normally"
        
    - name: üì§ Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep.sarif
      if: always() && secrets.SEMGREP_APP_TOKEN != ''
      continue-on-error: true