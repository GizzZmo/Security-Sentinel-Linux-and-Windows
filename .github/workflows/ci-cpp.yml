name: 🔨 C++ Build CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.hpp'
      - 'CMakeLists.txt'
      - 'include/**'
      - 'src/**'
      - '.github/workflows/ci-cpp.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.cpp'
      - '**.h'
      - '**.hpp'
      - 'CMakeLists.txt'
      - 'include/**'
      - 'src/**'

jobs:
  build-windows:
    name: 🪟 Build Windows (MSVC)
    runs-on: windows-latest
    
    strategy:
      matrix:
        build_type: [Debug, Release]
        
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      
    - name: 🛠️ Setup MSVC
      uses: microsoft/setup-msbuild@6fb02220983dee41ce7ae257b6f4d8f9bf5ed4ce
      
    - name: 📦 Setup CMake
      uses: lukka/get-cmake@628dd514bed37cb0a609e84a6186cbbaa2fc0140
      
    - name: 🔧 Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        
    - name: 🔨 Build C++ Project
      run: |
        cmake --build build --config ${{ matrix.build_type }} --parallel
        
    - name: 📋 List build outputs
      run: |
        echo "### Build Output Files 📁" >> $env:GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $env:GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $env:GITHUB_STEP_SUMMARY
        Get-ChildItem -Path "build" -Recurse -Include "*.exe", "*.dll", "*.lib" | ForEach-Object {
          $size = [math]::Round($_.Length / 1KB, 2)
          echo "| $($_.FullName) | ${size} KB |" >> $env:GITHUB_STEP_SUMMARY
        }
        
    - name: 🧪 Run basic executable test
      run: |
        echo "🔍 Searching for built executable..."
        $exe_path = Get-ChildItem -Path "build" -Recurse -Include "SecuritySentinel.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
        if ($exe_path) {
          echo "✅ Found executable: $($exe_path.FullName)"
          echo "📏 File size: $([math]::Round($exe_path.Length / 1MB, 2)) MB"
          echo "✅ Executable built successfully" >> $env:GITHUB_STEP_SUMMARY
        } else {
          echo "⚠️ SecuritySentinel.exe not found, checking for other executables..."
          $any_exe = Get-ChildItem -Path "build" -Recurse -Include "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($any_exe) {
            echo "✅ Found executable: $($any_exe.FullName)" 
            echo "✅ Build successful (alternate executable found)" >> $env:GITHUB_STEP_SUMMARY
          } else {
            echo "❌ No executable found in build directory" >> $env:GITHUB_STEP_SUMMARY
            exit 1
          }
        }
        
    - name: 📤 Upload build artifacts
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
      with:
        name: cpp-build-${{ matrix.build_type }}
        path: |
          build/bin/
          build/Release/
          build/Debug/
        retention-days: 7

  code-analysis:
    name: 🔍 Static Code Analysis
    runs-on: windows-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      
    - name: 🛠️ Setup MSVC
      uses: microsoft/setup-msbuild@6fb02220983dee41ce7ae257b6f4d8f9bf5ed4ce
      
    - name: 📦 Setup CMake
      uses: lukka/get-cmake@628dd514bed37cb0a609e84a6186cbbaa2fc0140
      
    - name: 🔧 Configure with static analysis
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Debug
        
    - name: 🔍 Run MSVC static analysis
      run: |
        echo "### Static Analysis Report 🔍" >> $env:GITHUB_STEP_SUMMARY
        try {
          msbuild build/SecuritySentinel.vcxproj /p:Configuration=Debug /p:Platform=x64 /p:RunCodeAnalysis=true /p:CodeAnalysisRuleSet=AllRules.ruleset
          echo "✅ Static analysis completed successfully" >> $env:GITHUB_STEP_SUMMARY
        } catch {
          echo "⚠️ Static analysis found issues (see build logs)" >> $env:GITHUB_STEP_SUMMARY
        }
      continue-on-error: true

  security-check:
    name: 🔒 Security Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      
    - name: 🔍 Run Semgrep security scan
      uses: semgrep/semgrep-action@713efdd345f3035192eaa63f56867b88e63e4e5d
      with:
        config: >-
          p/security-audit
          p/secrets
          p/cwe-top-25
        generateSarif: "1"
      env:
        SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      continue-on-error: true
      if: ${{ secrets.SEMGREP_APP_TOKEN != '' }}
        
    - name: 🔍 Skip Semgrep (no token)
      if: ${{ secrets.SEMGREP_APP_TOKEN == '' }}
      run: |
        echo "⚠️ SEMGREP_APP_TOKEN not configured, skipping security scan"
        echo "This is optional and workflow will continue normally"
        echo "To enable Semgrep scanning, add SEMGREP_APP_TOKEN secret to repository settings"
        echo "### Security Scan Status" >> $GITHUB_STEP_SUMMARY
        echo "ℹ️ Semgrep scanning skipped (no token configured)" >> $GITHUB_STEP_SUMMARY
        
    - name: 📤 Upload SARIF file to GitHub Security
      uses: github/codeql-action/upload-sarif@64d10c13136e1c5bce3e5fbde8d4906eeaafc885
      with:
        sarif_file: semgrep.sarif
        category: semgrep
      if: always() && hashFiles('semgrep.sarif') != ''
      continue-on-error: true
      
    - name: 📤 Upload SARIF as artifact
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
      with:
        name: semgrep-sarif-results
        path: semgrep.sarif
        retention-days: 30
      if: always() && hashFiles('semgrep.sarif') != ''