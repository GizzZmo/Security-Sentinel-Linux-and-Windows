name: ðŸŒ Web Interface CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - '**.json'
      - '**.html'
      - '**.css'
      - 'package*.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/ci-web.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - '**.json'
      - '**.html'
      - '**.css'
      - 'package*.json'
      - 'vite.config.ts'
      - 'tsconfig.json'

jobs:
  build-and-test:
    name: ðŸ”¨ Build & Test Web Interface
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v5
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ” Run TypeScript checks
      run: npx tsc --noEmit
      
    - name: ðŸ”¨ Build project
      run: npm run build
      
    - name: ðŸ“ Check bundle size
      run: |
        echo "### Bundle Size Report ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        find dist -type f -name "*.js" -o -name "*.css" | head -10 | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "| $file | $size |" >> $GITHUB_STEP_SUMMARY
        done
        
    - name: ðŸ“¤ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build-${{ matrix.node-version }}
        path: dist/
        retention-days: 7

  lint:
    name: ðŸ§¹ Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ” Run ESLint (if configured)
      run: |
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ] || [ -f ".eslintrc" ] || [ -f "eslint.config.mjs" ]; then
          echo "ESLint configuration found, running linter..."
          npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 10 || echo "ESLint found issues (allowing up to 10 warnings)"
        else
          echo "âœ“ ESLint not configured, skipping linting"
        fi
      continue-on-error: true
      
    - name: ðŸŽ¨ Run Prettier check (if configured)
      run: |
        if [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ]; then
          npx prettier --check .
        else
          echo "Prettier not configured, skipping..."
        fi
      continue-on-error: true

  security-scan:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v5
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ” Run npm audit
      run: |
        echo "ðŸ”’ Running security audit..."
        npm audit --audit-level moderate || echo "âš ï¸ Security issues found, but workflow continues"
        echo "### Security Audit Results ðŸ”’" >> $GITHUB_STEP_SUMMARY
        echo "See full results above. Non-critical vulnerabilities are informational." >> $GITHUB_STEP_SUMMARY
      continue-on-error: true