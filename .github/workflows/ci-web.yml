name: 🌐 Web Interface CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - '**.json'
      - '**.html'
      - '**.css'
      - 'package*.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/ci-web.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - '**.json'
      - '**.html'
      - '**.css'
      - 'package*.json'
      - 'vite.config.ts'
      - 'tsconfig.json'

jobs:
  build-and-test:
    name: 🔨 Build & Test Web Interface
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      
    - name: 🟢 Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: npm ci
      
    - name: 🔍 Run TypeScript checks
      run: npx tsc --noEmit
      
    - name: 🔨 Build project
      run: npm run build
      
    - name: 📏 Check bundle size
      run: |
        echo "### Bundle Size Report 📊" >> $GITHUB_STEP_SUMMARY
        echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        find dist -type f -name "*.js" -o -name "*.css" | head -10 | while read file; do
          size=$(du -h "$file" | cut -f1)
          echo "| $file | $size |" >> $GITHUB_STEP_SUMMARY
        done
        
    - name: 📤 Upload build artifacts
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
      with:
        name: web-build-${{ matrix.node-version }}
        path: dist/
        retention-days: 7

  lint:
    name: 🧹 Code Quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: npm ci
      
    - name: 🔍 Run ESLint with SARIF output
      run: |
        if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ] || [ -f ".eslintrc" ] || [ -f "eslint.config.mjs" ]; then
          echo "ESLint configuration found, running linter with SARIF output..."
          npm install --save-dev @microsoft/eslint-formatter-sarif
          npx eslint . --ext .ts,.tsx,.js,.jsx \
            --format @microsoft/eslint-formatter-sarif \
            --output-file eslint-results.sarif || echo "ESLint found issues"
          
          # Also run with standard output for console
          npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 10 || echo "ESLint completed with warnings"
        else
          echo "✓ ESLint not configured, skipping linting"
        fi
      continue-on-error: true
      
    - name: 📤 Upload ESLint SARIF results to GitHub
      uses: github/codeql-action/upload-sarif@f443b600d91635bebf5b0d9ebc620189c0d6fba5
      with:
        sarif_file: eslint-results.sarif
        category: eslint
      if: always() && hashFiles('eslint-results.sarif') != ''
      continue-on-error: true
      
    - name: 📤 Upload ESLint results as artifact
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
      with:
        name: eslint-sarif-results
        path: eslint-results.sarif
        retention-days: 30
      if: always() && hashFiles('eslint-results.sarif') != ''
      
    - name: 🎨 Run Prettier check (if configured)
      run: |
        if [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ]; then
          npx prettier --check .
        else
          echo "Prettier not configured, skipping..."
        fi
      continue-on-error: true

  security-scan:
    name: 🔒 Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      
    - name: 🟢 Setup Node.js
      uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: 📦 Install dependencies
      run: npm ci
        
    - name: 🔍 Run npm audit with JSON output
      run: |
        echo "🔒 Running security audit..."
        npm audit --json > npm-audit.json || echo "⚠️ Security issues found, but workflow continues"
        cat npm-audit.json
      continue-on-error: true
      
    - name: 🔄 Convert npm audit to SARIF
      run: |
        # Install npm-audit-sarif converter
        npm install -g npm-audit-sarif
        
        # Convert npm audit JSON to SARIF format
        cat npm-audit.json | npx npm-audit-sarif@latest > npm-audit.sarif || echo "Conversion completed"
        
        # Display summary
        echo "### Security Audit Results 🔒" >> $GITHUB_STEP_SUMMARY
        if [ -s npm-audit.sarif ]; then
          echo "✅ SARIF report generated successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ No vulnerabilities found or SARIF generation skipped" >> $GITHUB_STEP_SUMMARY
        fi
      continue-on-error: true
      
    - name: 📤 Upload npm audit SARIF to GitHub
      uses: github/codeql-action/upload-sarif@f443b600d91635bebf5b0d9ebc620189c0d6fba5
      with:
        sarif_file: npm-audit.sarif
        category: npm-audit
      if: always() && hashFiles('npm-audit.sarif') != ''
      continue-on-error: true
      
    - name: 📤 Upload audit results as artifact
      uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08
      with:
        name: npm-audit-results
        path: |
          npm-audit.json
          npm-audit.sarif
        retention-days: 30
      if: always()